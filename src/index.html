<html>

    <head>
        <!-- Google Tag Manager -->
        <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
            new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
            j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
            'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
            })(window,document,'script','dataLayer','GTM-WRSW7SKN');</script>
        <!-- End Google Tag Manager -->
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="description" content="Charting financial simulations for saving, investment, retirement, and knowledge">
        <meta name="robots" content="follow, index, max-snippet:-1, max-video-preview:-1, max-image-preview:large"/>
        <title>ðŸ“ˆ Charting Financial Models and Projecting for Saving, Investing, Retiring, and Knowledge</title>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script src="js/charting.js"></script>
        <script src="js/chronometer.js"></script>
        <script src="js/globals.js"></script>
        <script src="js/html.js"></script>
        <script src="js/logger.js"></script>
        <script src="js/membrane.js"></script>
        <script src="js/model.js"></script>
        <script src="js/portfolio.js"></script>
        <script src="js/summary.js"></script>
        <script src="js/taxes.js"></script>
        <script src="js/user.js"></script>
        <script src="js/util.js"></script>
        <link rel="stylesheet" href="index.css">
    </head>
    <body>
        <nav>
            <ul>
                <li><u>Home</u></li>
                <li><a href="rules.html">Rules</a></li>
                <li><a href="globals.html">Globals</a></li>
                <li><a href="disclaimer.html">Disclaimer</a></li>
                <li><a href="about.html">About</a></li>
            </ul>
        </nav>
        <h1 style="text-align: center;">
            Charting Financial Assets Over Time
        </h1>
        
        <!-- Popup Forms -->
        <div id="popupFormShare" class="popup">
            <div class="popup-content">
                <span class="closeBtn">&times;</span>
                <h2 id="popupTitle">Buy me a Coffee!</h2><br />
                <p>This will help pay for server costs as this project grows-- like the sharing feature.</p>
                <h2><a href='https://buymeacoffee.com/charting.finance' target="_blank">Visit my Coffee</a></h2>
            </div>
        </div>

        <div id="popupFormTransfers" class="popup">
            <div class="popup-content width-full">
                <span class="closeBtn" style="width: 100%; text-align: right;">&times;</span>  
                <div style="float: left; width: 50%">             
                    <h3 id="popupFormTransfers-title"></h3>
                    <br /><br />
                    <div class="width-full" style="padding-top: 10px;">                        
                        <canvas id="chartEarningsCanvasIndividual"></canvas>
                    </div>
                </div>
                <div style="float: left; width: 50%">
                    <h3>Transferrable Cards</h3>
                    <div class="scrollable-y">                    
                    </div>
                </div>
                <br />&nbsp;<br />
                <div class="width-full" style="clear: both; width: 100%; text-align: center; padding: 10px;">
                    <button onclick="popupFormTransfers_onSave()">Save</button>
                </div>
            </div>
        </div>

        <div class="row" id="topContainer">
            <div class="column left" style="text-align: center;">
                <div style="width: 100%">
                    <!--                    
                    <select id="savedDataSets" style="height: 30px; width: 100%; max-width: 300px;" onchange="selectLocalData_changed()"><option>None</option></select>
                    -->
                    <button onclick="aplus_save()" title="Save the current financial cards in the A spot">A+</button>&nbsp;<button onclick="aplus_recall()" title="Recall financial cards from the A spot">AR</button>&nbsp;&nbsp; | &nbsp;&nbsp;<button onclick="bplus_click()" title="Save the current financial cards in the B spot">B+</button>&nbsp;<button onclick="bplus_recall()" title="Recall financial cards from the B spot">BR</button>
                </div><br />
                <h3>Enter Financial Data</h3>
                <form id="asset" class="asset">
                    <div style="overflow: hidden; padding: 10px">
                        <div class="width-full" style="float: left">
                            <label for="instrument">Financial Instrument</label><br />
                            <select class="width-full" name="instrument">                                
                            </select><br />
                            <label for="displayName">Familiar Name</label>
                            <input type="text" class="width-full" name="displayName" placeholder="familiar name" /><br />
                        </div>
                        <div class="width-full" style="float: left; padding-top: 10px">
                            <div style="float: left; width: 55%">
                                <label for="startDate">Start Date</label><br />
                                <input type="month" class="width-full" name="startDate" required />
                            </div>
                            <div style="float: left; width: 45%">
                                <label for="startValue">Start Value</label><br />
                                <input type="number" class="width-full" name="startValue" placeholder="dollar amount" required />
                            </div>
                        </div>
                        <div class="width-full" style="float: left; padding-top: 10px">
                            <div style="float: left; width: 55%">
                                <label for="finishDate">Finish Date</label><br />
                                <input type="month" class="width-full" name="finishDate" required />
                            </div>
                            <div style="float: left; width: 45%">
                                <label for="finishValue">Finish Value</label><br />
                                <input type="number" class="width-full" name="finishValue" placeholder="computed" disabled />
                            </div>
                        </div>
                        <div class="width-full" style="float: left; padding-top: 10px">
                            <div style="float: left; width: 55%">    
                                <label for="annualReturnRate">Annual Return %</label><br />
                                <input type="number" class="width-full" name="annualReturnRate" step="0.01" placeholder="in decimal" required />        
                            </div>
                            <div name="slot1" style="float: left; width: 45%">
                                <label class="hidable" for="basisValue">Basis Value</label><br class="hidable" />
                                <input class="hidable" type="number" style="width: 125px" name="basisValue" value="0" placeholder="original asset cost" />                                
                            </div>
                        </div>
                    </div><br />
                    <input type="submit" value="Create" title="Add this 'card' of financial data to the active set of financial cards to the right" />
                </form>
            </div>
            <div class="column middle">
                <div style="text-align: center; clear: both">
                    <a href="https://buymeacoffee.com/charting.finance" target="_blank">Buy me a Coffee</a><br /><br />
                    <button onclick="calculate('assets')" title="Incorporate any changes made to the financial cards and recalculate">Recalculate Assets</button>
                </div>
                <br />
                <div style="padding: 10px" class="scrollable-x selected-assets" id="assets"></div>                
            </div>
            <div class="column right" style="text-align: center">
                <div style="width: 100%;">
                    <input id="sharedDataSets" style="height: 30px; width: 100%; max-width: 300px;" placeholder="click 'share' to generate url"><br />
                    <button class="common-margin" onclick="shareData()">Share</button>
                </div>            
                <h3>Rolled Up Financial Data</h3>
                <form class="rollup" id="rollup1">
                    <div style="overflow: hidden;">
                        <div class="width-full" style="float: left;">
                            <label for="instrument">Financial Instrument</label><br />
                            <input type="text" class="width-full" name="instrument" value="All Instruments" /><br />
                            <label for="displayName" class="invisible">Familiar Name</label><br />
                            <input type="text" class="invisible width-full" name="displayName" placeholder="familiar name" />
                        </div>
                        <div class="width-full" style="float: left; padding-top: 10px;">
                            <div style="float: left; width: 55%">
                                <label for="startDate">Start Date</label><br />
                                <input type="month" class="width-full" name="startDate" readonly />
                            </div>
                            <div style="float: left; width: 45%">
                                <label for="startValue">Start Asset Value</label><br />
                                <input type="number" class="width-full" name="startValue" step="0.01" placeholder="computed" readonly />
                            </div>
                        </div>
                        <div class="width-full" style="float: left; padding-top: 10px">
                            <div style="float: left; width: 55%">
                                <label for="finishDate">Finish Date</label><br />
                                <input type="month" class="width-full" name="finishDate" readonly />
                            </div>
                            <div style="float: left; width: 45%">
                                <label for="finishValue">Finish Asset Value</label><br />
                                <input type="number" class="width-full" name="finishValue" step="0.01" placeholder="computed" readonly />                                
                            </div>
                        </div>
                        <div class="width-full" style="float: left; padding-top: 10px">
                            <label for="totalMonths">Total Months</label><br />
                            <input type="number" style="width: 125px"  name="totalMonths" placeholder="total months processed" readonly /><br />
                            <label for="accumulatedValue">Earned Asset Value</label><br />                                
                            <input type="number" name="accumulatedValue" step="0.01" placeholder="accumulated value" readonly /><br />
                            <label for="annualReturnRate">Annual Growth %</label><br />
                            <input type="number" name="annualReturnRate" step="0.01" placeholder="annual return rate" readonly /><br />
                        </div>
                    </div>
                </form>                 
            </div>
        </div>

        <br />
        <div style="text-align: center; clear: both">
            <button id="showHideSimulator" onclick="clickShowHideSimulator()">Show Simulator</button>
        </div>
        <br />        

        <div class="row" id="middleContainer" style="display: none;">
            <div class="column left" style="text-align: center;">
                <div style="width: 100%">
                </div><br />
                <h3>Goals</h3>
                <button onclick="doMaximize()">Maximize</button>
                <br />
                <textarea id="permutations" style="height: 300px; width: 100%; overflow: auto;" placeholder="Funding transfer Combinations."></textarea>                
            </div>
            <div class="column middle">
                <div style="text-align: center; clear: both">
                    <button onclick="calculate('simulator')" title="Incorporate any changes made to the simulated financial cards and recalculate">Recalculate Simulation</button>
                </div>
                <br />
                <div style="padding: 10px" class="scrollable-x" id="assetsSimulator"></div>                
            </div>
            <div class="column right" style="text-align: center">
                <div style="width: 100%;">
                </div>            
                <h3>Rolled Up Financial Data</h3>
                <form class="rollup" id="rollup2">
                    <div style="overflow: hidden;">
                        <div class="width-full" style="float: left;">
                            <label for="instrument">Financial Instrument</label><br />
                            <input type="text" class="width-full" name="instrument" value="All Instruments" /><br />
                            <label for="displayName" class="invisible">Familiar Name</label><br />
                            <input type="text" class="invisible width-full" name="displayName" placeholder="familiar name" />
                        </div>
                        <div class="width-full" style="float: left; padding-top: 10px;">
                            <div style="float: left; width: 55%">
                                <label for="startDate">Start Date</label><br />
                                <input type="month" class="width-full" name="startDate" readonly />
                            </div>
                            <div style="float: left; width: 45%">
                                <label for="startValue">Start Asset Value</label><br />
                                <input type="number" class="width-full" name="startValue" step="0.01" placeholder="computed" readonly />
                            </div>
                        </div>
                        <div class="width-full" style="float: left; padding-top: 10px">
                            <div style="float: left; width: 55%">
                                <label for="finishDate">Finish Date</label><br />
                                <input type="month" class="width-full" name="finishDate" readonly />
                            </div>
                            <div style="float: left; width: 45%">
                                <label for="finishValue">Finish Asset Value</label><br />
                                <input type="number" class="width-full" name="finishValue" step="0.01" placeholder="computed" readonly />                                
                            </div>
                        </div>
                        <div class="width-full" style="float: left; padding-top: 10px">
                            <label for="totalMonths">Total Months</label><br />
                            <input type="number" style="width: 125px"  name="totalMonths" placeholder="total months processed" readonly /><br />
                            <label for="accumulatedValue">Earned Asset Value</label><br />                                
                            <input type="number" name="accumulatedValue" step="0.01" placeholder="accumulated value" readonly /><br />
                            <label for="annualReturnRate">Annual Growth %</label><br />
                            <input type="number" name="annualReturnRate" step="0.01" placeholder="annual return rate" readonly /><br />
                        </div>
                    </div>
                </form>                 
            </div>
        </div>

        <br /><br />

        <div class="row" style="padding-left: 24px; padding-right: 24px;" id="bottomContainer">
            <div class="tabs">
                <div class="tab active" id="tab1" onclick="tab1_click()">
                    <span>Asset View</span>
                </div>
                <div class="tab" id="tab2" onclick="tab2_click()">
                    <span>Earnings View</span>
                </div>
                <div>
                    <div class="tab" id="tab3" onclick="tab3_click()">
                        <span>Growth View</span>
                    </div>
                </div>
                <div>
                    <div class="tab-reports">
                        <span>Reports</span>
                    </div>
                </div>
            </div>

            <div style="float: left; width: 75%">
                <div style="width: 100%">
                    <canvas id="chartAssetCanvas"></canvas>
                </div>
                <div style="width: 100%; display: none">
                    <canvas id="chartEarningsCanvas"></canvas>
                </div>
                <div style="width: 100%; display: none">
                    <canvas id="chartCashFlowCanvas"></canvas>
                </div>
            </div>
            <div style="float: left; width: 25%">
                <div style="width: 100%; padding: 8px;">
                    <div id="reports" style="height: 700px"></div>
                </div>
            </div>
            <div class="column left">
            </div>
         
        </div>           

        <script>
            <!-- these are dynamic functions -->

            var topRowContainerElement = document.getElementById('topRowContainer');
            var bottomRowElement = document.getElementById('bottomRowContainer');
            var assetElement = document.getElementById('asset');

            var assetsContainerElement = document.getElementById('assets');
            var assetsSimulatorElement = document.getElementById('assetsSimulator');
            var activeAssetsElement = assetsContainerElement;

            var assetsSummaryElement = document.getElementById('rollup1');
            var assetsSimulatorSummaryElement = document.getElementById('rollup2');
            var activeSummaryElement = assetsSummaryElement;
            
            var chartAssetCanvas = document.getElementById('chartAssetCanvas');
            var chartEarningsCanvas = document.getElementById('chartEarningsCanvas');
            var chartCashFlowCanvas = document.getElementById('chartCashFlowCanvas');
            var chartEarningsCanvasIndividual = document.getElementById('chartEarningsCanvasIndividual');
            var reportsElement = document.getElementById('reports');
            var activeStoryArc = null;
            var activeStoryName = null;
            var activeAssetCanvas = null;
            var activeEarningsCanvas = null;
            var activeCashFlowCanvas = null;
            var activeEarningsCanvasIndividual = null;

            var highlightDisplayName = null;
        </script>
        <script>
            <!-- these are initial setup functions -->

            function buildInstrumentOptions() {
                let selectElement = assetElement.querySelector('[name="instrument"]');
                selectElement.innerHTML = html_buildInstrumentOptions(null)
            }

            function initiateActiveData() {
                logger.log('initiateActiveData');

                // TODO - get this from a global options setting
                let startDateElement = assetElement.querySelector('[name="startDate"]');
                let di = DateInt.parse(new Date().toISOString());
                startDateElement.value = di.toHTML();

                activeStoryArc = localStorage.getItem('activeStoryArc');
                if (!activeStoryArc)
                    activeStoryArc = 'default';

                activeStoryName = localStorage.getItem('activeStoryName');
                if (!activeStoryName) {
                    activeStoryName = util_YYYYmm();
                    util_ensureStoryNames(activeStoryArc, activeStoryName);
                }

                // Get the last working data set
                loadLocalData();
            }

            function hideElementsWithScope(scopeElement) {
                let invisibleElements = scopeElement.querySelectorAll('.invisible');
                invisibleElements.forEach(invisibleElement => {
                    invisibleElement.style.display = '';
                });

                let hidableElements = scopeElement.querySelectorAll('.hidable');
                hidableElements.forEach(hidableElement => {
                    hidableElement.style.display = 'none';
                });
            }

            function connectAssetSelect() {
                logger.log('connectAssetSelect');
                let instrumentElement = assetElement.querySelector('[name="instrument"]')
                let slot1Element = assetElement.querySelector('[name="slot1"]');

                instrumentElement.addEventListener('change', function(event) {
                    slot1Element.innerHTML = html_buildSlotElement(event.target.value, null);
                });
            }

            function connectAssetsContainerSelects() {
                logger.log('connectAssetsContainerSelects');
                assetsContainerElement.addEventListener('change', function(event) {
                    if (event.target.name == 'instrument') {
                        let slot1Element = event.target.parentElement.parentElement.querySelector('[name="slot1"]');
                        slot1Element.innerHTML = html_buildSlotElement(event.target.value, null);
                    }
                });
            }

            function connectCreateAsset() {
                logger.log('connectCreateAsset');
                assetElement.addEventListener("submit", function(ev) {
                    ev.preventDefault();

                    let assetModel = membrane_htmlElementToAssetModel(assetElement); 
                    //gtag("event", "asset_add", null);                                    
                    assetsContainerElement.innerHTML += html_buildRemovableAssetElement(null, assetModel);
                   
                    calculate('assets');
                });
            }

            function connectAssetsContainerTransfers() {

                logger.log('connectAssetsContainerTransfers');
                assetsContainerElement.addEventListener('click', assetsContainerElementClickTransfers);
                assetsSimulatorElement.addEventListener('click', assetsContainerElementClickTransfers);

            }

            function assetsContainerElementClickTransfers (ev) {
                    
                if (ev.srcElement.name == sFundTransfers) {
                    event.preventDefault();
                    let assetElement = ev.srcElement.parentNode.parentNode.parentNode;
                    let containerElement = assetElement.parentElement;
                    let displayName = assetElement.querySelector('input[name="displayName"]').value;                        
                    showPopupTransfers(containerElement, displayName);
                }

            }

            function connectAssetsContainerRemove() {
                logger.log('connectUpdateOrRemoveAsset');
                assetsContainerElement.addEventListener('click', function (ev) {

                    if (ev.srcElement.className.includes('remove')) {
                        ev.preventDefault();

                        let removeContainerNode = ev.srcElement.parentNode;                    
                        while (removeContainerNode.parentNode.id != 'assets')
                            removeContainerNode = removeContainerNode.parentNode;
                        assetsContainerElement.removeChild(removeContainerNode);

                        calculate('assets');
                    }

                });
            }

        </script>
        <script>
            <!-- Mouse Handlers -->

            function clearMouseEvents() {
                let cardChartColors = assetsContainerElement.querySelectorAll('.card-chart-color');
                for (let ii = 0; ii < cardChartColors.length; ii++) {
                    cardChartColors[ii].removeEventListener('click', handleMouseEvents);
                }
            }

            function attachMouseEvents() {
                let cardChartColors = assetsContainerElement.querySelectorAll('.card-chart-color');
                for (let ii = 0; ii < cardChartColors.length; ii++) {
                    cardChartColors[ii].addEventListener('click', handleMouseEvents);
                }
            }

            function handleMouseEvents(ev) {
                logger.log('element.click ' + ev.srcElement);

                // clear previous
                let selectedCardChartElement = document.querySelector('.selected-card-chart');
                if (selectedCardChartElement != null) {
                    selectedCardChartElement.classList.remove('selected-card-chart');
                }

                let highlightElement = ev.srcElement;
                if (highlightDisplayName == null) {                    
                    highlightElement.classList.add('selected-card-chart');
                    highlightDisplayName = ev.srcElement.parentElement.querySelector('input[name="displayName"]').value;
                }
                else {
                    let clickedHighlightDisplayName = ev.srcElement.parentElement.querySelector('input[name="displayName"]').value;
                    if (clickedHighlightDisplayName != highlightDisplayName) {
                        highlightElement.classList.add('selected-card-chart');
                        highlightDisplayName = ev.srcElement.parentElement.querySelector('input[name="displayName"]').value;
                    }
                    else
                        highlightDisplayName = null;
                }

                updateCharts();
            }

        </script>
        <script>
            /* Tab handling */
            function tab1_click() {
                if (tab2.classList.contains('active')) {
                    tab2.classList.remove('active');
                    chartEarningsCanvas.parentElement.style.display = 'none';
                }
                else if (tab3.classList.contains('active')) {
                    tab3.classList.remove('active');
                    chartCashFlowCanvas.parentElement.style.display = 'none';                    
                }
                /*
                else if (tab4.classList.contains('active')) {
                    tab4.classList.remove('active');
                    reportsElement.parentElement.style.display = 'none';
                }
                */
                tab1.classList.add('active');
                chartAssetCanvas.parentElement.style.display = '';
            }

            function tab2_click() {
                if (tab1.classList.contains('active')) {
                    tab1.classList.remove('active');
                    chartAssetCanvas.parentElement.style.display = 'none';
                }
                else if (tab3.classList.contains('active')) {
                    tab3.classList.remove('active');
                    chartCashFlowCanvas.parentElement.style.display = 'none';                    
                }
                /*
                else if (tab4.classList.contains('active')) {
                    tab4.classList.remove('active');
                    reportsElement.parentElement.style.display = 'none';
                }
                */
                tab2.classList.add('active');
                chartEarningsCanvas.parentElement.style.display = '';                
            }

            function tab3_click() {
                if (tab1.classList.contains('active')) {
                    tab1.classList.remove('active');
                    chartAssetCanvas.parentElement.style.display = 'none';
                }
                else if (tab2.classList.contains('active')) {
                    tab2.classList.remove('active');
                    chartEarningsCanvas.parentElement.style.display = 'none';                    
                }
                /*
                else if (tab4.classList.contains('active')) {
                    tab4.classList.remove('active');
                    reportsElement.parentElement.style.display = 'none';
                }
                */
                tab3.classList.add('active');
                chartCashFlowCanvas.parentElement.style.display = '';                
            }

            function tab4_click() {
                /*
                if (tab1.classList.contains('active')) {
                    tab1.classList.remove('active');
                    chartAssetCanvas.parentElement.style.display = 'none';
                }
                else if (tab2.classList.contains('active')) {
                    tab2.classList.remove('active');
                    chartEarningsCanvas.parentElement.style.display = 'none';                    
                }
                else if (tab3.classList.contains('active')) {
                    tab3.classList.remove('active');
                    chartCashFlowCanvas.parentElement.style.display = 'none';
                }
                tab4.classList.add('active');
                reportsElement.parentElement.style.display = '';
                */
            }
        </script>
        <script>
            <!-- A B save and recall -->

            function aplus_save() {
                let assetModels = membrane_htmlElementsToAssetModels(assetsContainerElement);
                util_saveLocalAssetModels(activeStoryArc, 'APlus', assetModels);
            }

            function aplus_recall() {
                let assetModelsRaw = util_loadLocalAssetModels(activeStoryArc, 'APlus');
                let assetModels = membrane_rawDataToModelAssets(assetModelsRaw);
                assetsContainerElement.innerHTML = membrane_modelAssetsToHTML(assetModels);
                calculate('assets');
            }

            function bplus_click() {
                let assetModels = membrane_htmlElementsToAssetModels(assetsContainerElement);
                util_saveLocalAssetModels(activeStoryArc, 'BPlus', assetModels);
            }

            function bplus_recall() {
                let assetModelsRaw = util_loadLocalAssetModels(activeStoryArc, 'BPlus');
                let assetModels = membrane_rawDataToModelAssets(assetModelsRaw);
                assetsContainerElement.innerHTML = membrane_modelAssetsToHTML(assetModels);
                calculate('assets');
            }
        </script>
        <script>
            <!-- charting -->

            function updateActiveAssetsElement(assetsElement, summaryElement) {

                assetsContainerElement.classList.remove('selected-assets');
                assetsSimulatorElement.classList.remove('selected-assets');
                assetsElement.classList.add('selected-assets');
                activeAssetsElement = assetsElement;
                activeSummaryElement = summaryElement;

            }

            function ensureHighlightDisplayName() {
                if (highlightDisplayName == null) {
                    let selectedCardCharts = assetsContainerElement.querySelectorAll('.selected-card-chart');
                    if (selectedCardCharts != null) {
                        for (let ii = 0; ii < selectedCardCharts.length; ii++) {
                            selectedCardCharts[ii].classList.remove('selected-card-chart');
                        }
                    }
                }
                else {
                    let displayNameElement = assetsContainerElement.querySelector('input[value="' + highlightDisplayName + '"]');
                    if (displayNameElement != null) {
                        displayNameElement.parentElement.parentElement.children[0].classList.add('selected-card-chart');
                    }
                }
            }
         
            function updateCharts() {

                let modelAssets = membrane_htmlElementsToAssetModels(activeAssetsElement);
                let portfolio = new Portfolio(modelAssets);
                chronometer_run(document.getElementById(activeSummaryElement), portfolio);
                portfolio.buildChartingDisplayData();
                ensureHighlightDisplayName();
                charting_buildFromPortfolio(portfolio, false);
                activeAssetCanvas.update(); 
                activeEarningsCanvas.update();
                activeCashFlowCanvas.update();                

            }

            function calculate(target) {
                reportsElement.innerHTML = '';
                
                if (target == 'assets')
                    updateActiveAssetsElement(assetsContainerElement, assetsSummaryElement);
                else if (target == 'simulator')
                    updateActiveAssetsElement(assetsSimulatorElement, assetsSimulatorSummaryElement);

                let modelAssets = membrane_htmlElementsToAssetModels(activeAssetsElement);
                let portfolio = new Portfolio(modelAssets, true);
                chronometer_run(activeSummaryElement, portfolio);

                // unhook mouse events
                clearMouseEvents();

                // use the updated modelAssets to produce the updated html
                activeAssetsElement.innerHTML = membrane_modelAssetsToHTML(portfolio.modelAssets);
                if (activeAssetsElement == assetsSimulatorElement) {
                    removeRemoveButtons(activeAssetsElement);
                }

                // hook mouse events
                attachMouseEvents();

                // prepare the chart data
                portfolio.buildChartingDisplayData();

                // if there is a highlightDisplayName, make sure it's selected
                ensureHighlightDisplayName();

                // then build the charts
                charting_buildFromPortfolio(portfolio, true);
                innerCalculate();

                if (activeAssetsElement == assetsContainerElement) {
                    saveLocalData();
                }
                
            };

            function innerCalculate() {              
                if (activeAssetCanvas != null)
                    activeAssetCanvas.destroy();
                if (activeEarningsCanvas != null)
                    activeEarningsCanvas.destroy();
                if (activeCashFlowCanvas != null)
                    activeCashFlowCanvas.destroy();
                if (charting_jsonAssetsChartData != null)
                    activeAssetCanvas = new Chart(chartAssetCanvas, charting_jsonAssetsChartData);
                if (charting_jsonEarningsChartData != null)
                    activeEarningsCanvas = new Chart(chartEarningsCanvas, charting_jsonEarningsChartData);
                if (charting_jsonCashFlowChartData != null)
                    activeCashFlowCanvas = new Chart(chartCashFlowCanvas, charting_jsonCashFlowChartData);
            }

            function selectLocalData_changed(ev) {
                const selectElement = document.getElementById('savedDataSets');
                activeStoryName = selectElement.value;
                loadLocalData();
            }

            function saveLocalData() {                
                let assetModels = membrane_htmlElementsToAssetModels(assetsContainerElement);
                util_saveLocalAssetModels(activeStoryArc, activeStoryName, assetModels);                                            
            }

            function loadLocalData() {                
                let assetModelsRaw = util_loadLocalAssetModels(activeStoryArc, activeStoryName);
                let assetModels = membrane_rawDataToModelAssets(assetModelsRaw);
                assetsContainerElement.innerHTML = membrane_modelAssetsToHTML(assetModels);
                calculate('assets');
            }
        </script>
        <script>
            // simulations
            function clickShowHideSimulator() {
                let middleContainerElement = document.getElementById('middleContainer');
                let showHideSimulatorButton = document.getElementById('showHideSimulator');

                if (middleContainerElement.style.display == 'none') {
                    updateActiveAssetsElement(assetsSimulatorElement, assetsSimulatorSummaryElement);
                    middleContainerElement.style.display = '';
                    showHideSimulatorButton.innerHTML = 'Hide Simulator';
                }
                else {
                    updateActiveAssetsElement(assetsContainerElement, assetsSummaryElement);
                    middleContainerElement.style.display = 'none';
                    showHideSimulatorButton.innerHTML = 'Show Simulator';
                }
            }            

            function doMaximize() {

                // copy the main html elements to the simulation div                
                let summaryContainerElement = document.getElementById('rollup2');

                assetsSimulatorElement.innerHTML = assetsContainerElement.innerHTML;
                removeRemoveButtons(assetsSimulatorElement);

                let modelAssets = membrane_htmlElementsToAssetModels(assetsSimulatorElement);

                if (window.Worker) {
                    let worker = new Worker('js/simulator.js');
                    worker.postMessage(modelAssets);
                    worker.onmessage = function(event) {
                        let richMessage = event.data;
                        if (richMessage.action == 'iteration') {
                            let permutationTextBox = document.getElementById('permutations');
                            permutationTextBox.value = richMessage.data;
                        }   
                        else if (richMessage.action == 'foundBetter') {
                            
                            let assetModels = membrane_jsonObjectsToModelAssets(richMessage.data);
                            let portfolio = new Portfolio(assetModels, false);
                            chronometer_run(null, portfolio);
                            assetsSimulatorElement.innerHTML = membrane_modelAssetsToHTML(portfolio.modelAssets);                                                    
                            buildSummary(summaryContainerElement, portfolio);
                            updateActiveAssetsElement(assetsSimulatorElement, assetsSimulatorSummaryElement);
                            //updateCharts();
                            calculate('simulator');

                        }                     
                        
                    }
                }
                else {
                    assetsSimulatorElement.innerHTML = 'Web Workers not supported in this browser.';
                }

            }

            function removeRemoveButtons(containerElement) {
                let removeButtons = containerElement.querySelectorAll('.remove');
                for (let ii = 0; ii < removeButtons.length; ii++) {
                    removeButtons[ii].remove();
                }
            }
        </script>
        <script>
            const saveLocally = 'Save Locally';
            const shareGlobally = 'Share Globally';
            // popup routines
            function saveData() {
                loadPopupList(saveLocally);
                doPopup(saveLocally);
            }

            function shareData() {
                // loadPopupList(shareGlobally);
                doPopupShare(shareGlobally);
            }

            function cardSelection() {
                doPopupCardSelection();
            }

            function loadPopupList(popupTitle) {
                let popupDatasets = document.getElementById('popupDatasets');
                let datasets = util_loadFromStorage(popupTitle);
                if (datasets && datasets.length > 0) {
                    popupDatasets.innertHTML = '';
                    for (let dataset of datasets) {
                        popupDatasets.innertHTML += '<option>' + dataset.displayName + '</option>';
                    }
                }
            }

            function doPopupShare(popupTitle) {
                document.getElementById('popupFormShare').style.display = 'block';
            }

            function showPopupTransfers(containerElement, currentDisplayName) {

                let popupFormTransfersElement = document.getElementById('popupFormTransfers');
                let scrollableYElement = popupFormTransfersElement.querySelector('.scrollable-y');

                let modelAssets = membrane_htmlElementsToAssetModels(containerElement);                
                let portfolio = new Portfolio(modelAssets, false);
                chronometer_run(null, portfolio);
                portfolio.buildChartingDisplayData();
                charting_buildFromModelAsset(portfolio, currentDisplayName);

                html_applyModelAssetToPopupTransfers(util_findModelAssetByDisplayName(portfolio.modelAssets, currentDisplayName), popupFormTransfersElement);
                scrollableYElement.innerHTML = html_buildTransferrableAssets(portfolio.modelAssets, currentDisplayName);
                
                if (activeEarningsCanvasIndividual != null)
                    activeEarningsCanvasIndividual.destroy();

                popupFormTransfersElement.style.display = 'block';

                if (charting_jsonEarningsChartDataIndividual != null)
                    activeEarningsCanvasIndividual = new Chart(chartEarningsCanvasIndividual, charting_jsonEarningsChartDataIndividual);

            }

            function popupFormTransfers_onSave(ev) {
                let popupFormTransfersElement = document.getElementById('popupFormTransfers');
                let currentDisplayName = popupFormTransfersElement.querySelector('#popupFormTransfers-title').innerHTML;
                let scrollableYElement = popupFormTransfersElement.querySelector('.scrollable-y');
                let fundTransfers = membrane_htmlElementsToFundTransfers(currentDisplayName, scrollableYElement);
                html_setAssetElementFundTransfers(currentDisplayName, fundTransfers);

                calculate();
                popupFormTransfersElement.style.display = 'none';
            }

            const closeButtonElements = document.querySelectorAll('.closeBtn');
            for (const closeButtonElement of closeButtonElements) {
                closeButtonElement.addEventListener('click', function() {
                    closeButtonElement.parentElement.parentElement.style.display = 'none';
                });
            }

        </script>
        <script>
            // initialization routines
            function initialize() {
                global_initialize();
                activeTaxTable = new TaxTable();
                buildInstrumentOptions();
                initiateActiveData();            
                connectAssetSelect();
                connectCreateAsset();
                connectAssetsContainerSelects();
                connectAssetsContainerTransfers();
                connectAssetsContainerRemove();
            }            

            initialize();
        </script>
    </body>
    <footer>
        <p>Â© Copyright 2025 Charting Finance, LLC</p>
    </footer>
</html>